# CHTL项目环境依赖文档

## 概述

本文档详细说明了CHTL项目的所有环境依赖、安装方法、版本要求和配置说明。确保您的开发环境满足这些要求，以获得最佳的开发体验。

## 核心依赖

### 🔧 **编译器要求**

#### C++编译器
| 编译器 | 最低版本 | 推荐版本 | 支持平台 | 说明 |
|--------|----------|----------|----------|------|
| **GCC** | 7.0 | 11.0+ | Linux, Windows (MinGW) | 完全支持C++17特性 |
| **Clang** | 6.0 | 13.0+ | Linux, macOS, Windows | 最佳调试体验 |
| **MSVC** | 19.14 (VS2017 15.7) | 19.29+ (VS2019) | Windows | 原生Windows支持 |
| **Apple Clang** | 10.0 | 13.0+ | macOS | Xcode集成 |

#### 安装方法

**Ubuntu/Debian:**
```bash
# GCC
sudo apt update
sudo apt install build-essential gcc-11 g++-11

# Clang
sudo apt install clang-13 libc++-13-dev libc++abi-13-dev

# 设置默认编译器
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 100
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 100
```

**CentOS/RHEL:**
```bash
# 启用开发工具
sudo yum groupinstall "Development Tools"
sudo yum install centos-release-scl
sudo yum install devtoolset-11

# 激活开发工具集
scl enable devtoolset-11 bash
```

**macOS:**
```bash
# 安装Xcode命令行工具
xcode-select --install

# 使用Homebrew安装最新编译器
brew install gcc llvm

# 验证安装
gcc --version
clang --version
```

**Windows:**
```bash
# 使用Chocolatey安装MinGW
choco install mingw

# 或下载并安装Visual Studio
# https://visualstudio.microsoft.com/downloads/
```

### 🏗️ **构建系统**

#### CMake
- **最低版本**: 3.15
- **推荐版本**: 3.20+
- **必需特性**: C++17支持、FindPackage模块

**安装方法:**
```bash
# Ubuntu/Debian
sudo apt install cmake

# CentOS/RHEL
sudo yum install cmake3

# macOS
brew install cmake

# Windows
choco install cmake

# 从源码编译最新版本
wget https://github.com/Kitware/CMake/releases/download/v3.25.0/cmake-3.25.0.tar.gz
tar -xzf cmake-3.25.0.tar.gz
cd cmake-3.25.0
./bootstrap && make -j$(nproc) && sudo make install
```

#### 构建工具
```bash
# Make (推荐)
sudo apt install make  # Ubuntu/Debian
sudo yum install make  # CentOS/RHEL
brew install make      # macOS

# Ninja (更快的构建)
sudo apt install ninja-build  # Ubuntu/Debian
sudo yum install ninja-build  # CentOS/RHEL
brew install ninja            # macOS
choco install ninja           # Windows
```

### 📚 **第三方库**

#### ANTLR4 (可选但推荐)
- **版本**: 4.13.2
- **用途**: CSS和JavaScript语法解析
- **许可证**: BSD 3-Clause

**安装方法:**
```bash
# Ubuntu/Debian
sudo apt install libantlr4-runtime-dev antlr4

# macOS
brew install antlr antlr4-cpp-runtime

# 从源码编译
wget https://www.antlr.org/download/antlr4-cpp-runtime-4.13.2-source.zip
unzip antlr4-cpp-runtime-4.13.2-source.zip
cd antlr4-cpp-runtime-4.13.2-source
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install
```

#### Google Test (测试框架)
- **版本**: 1.10+
- **用途**: 单元测试和集成测试

**安装方法:**
```bash
# Ubuntu/Debian
sudo apt install libgtest-dev libgmock-dev

# macOS
brew install googletest

# 从源码编译
git clone https://github.com/google/googletest.git
cd googletest
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
make -j$(nproc)
sudo make install
```

## 开发工具

### 🐛 **调试工具**

#### GDB (GNU Debugger)
```bash
# Ubuntu/Debian
sudo apt install gdb

# CentOS/RHEL
sudo yum install gdb

# macOS (可能需要签名)
brew install gdb
```

#### Valgrind (内存检查 - 仅Linux)
```bash
# Ubuntu/Debian
sudo apt install valgrind

# CentOS/RHEL
sudo yum install valgrind

# 使用方法
valgrind --tool=memcheck --leak-check=full ./your_program
```

#### LLDB (LLVM Debugger)
```bash
# Ubuntu/Debian
sudo apt install lldb

# macOS (内置)
# 已包含在Xcode中

# 使用方法
lldb ./your_program
```

### 📝 **代码编辑器和IDE**

#### Visual Studio Code (推荐)
**必需扩展:**
- C/C++ Extension Pack (Microsoft)
- CMake Tools
- GitLens
- Clang-Format

**配置文件 (.vscode/settings.json):**
```json
{
    "C_Cpp.default.cppStandard": "c++17",
    "C_Cpp.default.compilerPath": "/usr/bin/g++",
    "C_Cpp.default.includePath": [
        "${workspaceFolder}/src",
        "${workspaceFolder}/third-party/include"
    ],
    "cmake.buildDirectory": "${workspaceFolder}/build",
    "cmake.generator": "Unix Makefiles"
}
```

#### CLion (JetBrains)
- 商业IDE，提供优秀的C++支持
- 内置CMake集成
- 强大的调试和分析工具

#### Qt Creator
- 免费的跨平台IDE
- 优秀的CMake支持
- 内置调试器

### 🔍 **静态分析工具**

#### Clang-Tidy
```bash
# 安装
sudo apt install clang-tidy

# 配置文件 (.clang-tidy)
Checks: '*,-android-*,-fuchsia-*,-google-*,-zircon-*,-abseil-*,-modernize-use-trailing-return-type'
HeaderFilterRegex: '.*'
AnalyzeTemporaryDtors: false
FormatStyle:     file
```

#### Cppcheck
```bash
# 安装
sudo apt install cppcheck

# 使用
cppcheck --enable=all --std=c++17 src/
```

#### AddressSanitizer & UBSan
```bash
# 编译时启用
cmake .. -DCMAKE_CXX_FLAGS="-fsanitize=address -fsanitize=undefined"
```

## 运行时环境

### 🌐 **目标环境**

#### Linux发行版支持
| 发行版 | 版本 | 状态 | 说明 |
|--------|------|------|------|
| **Ubuntu** | 18.04+ | ✅ 完全支持 | 推荐LTS版本 |
| **Debian** | 10+ | ✅ 完全支持 | 稳定版本 |
| **CentOS** | 7+ | ✅ 支持 | 需要devtoolset |
| **RHEL** | 7+ | ✅ 支持 | 企业级支持 |
| **Fedora** | 30+ | ✅ 支持 | 最新特性 |
| **Arch Linux** | Rolling | ✅ 支持 | 滚动更新 |

#### Windows版本支持
- **Windows 10** (1903+): 完全支持
- **Windows 11**: 完全支持
- **Windows Server 2019+**: 支持

#### macOS版本支持
- **macOS 10.15** (Catalina): 基本支持
- **macOS 11.0** (Big Sur): 完全支持
- **macOS 12.0+** (Monterey+): 完全支持

### 📦 **包管理器**

#### vcpkg (Windows推荐)
```bash
# 安装vcpkg
git clone https://github.com/Microsoft/vcpkg.git
cd vcpkg
./bootstrap-vcpkg.bat  # Windows
./bootstrap-vcpkg.sh   # Linux/macOS

# 安装依赖
./vcpkg install gtest antlr4[cpp]
```

#### Conan (跨平台)
```bash
# 安装Conan
pip install conan

# 创建配置文件 (conanfile.txt)
[requires]
gtest/1.11.0
antlr4-cppruntime/4.13.2

[generators]
cmake

# 安装依赖
conan install . --build missing
```

## 环境变量配置

### 🔧 **必需的环境变量**

```bash
# 编译器路径 (如果不在PATH中)
export CC=/usr/bin/gcc-11
export CXX=/usr/bin/g++-11

# CMake配置
export CMAKE_BUILD_TYPE=Release
export CMAKE_INSTALL_PREFIX=/usr/local

# CHTL特定配置
export CHTL_ROOT=/path/to/chtl
export CHTL_MODULE_PATH=/path/to/chtl/modules

# ANTLR4配置 (如果手动安装)
export ANTLR4_ROOT=/usr/local
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ANTLR4_ROOT/lib

# Google Test配置 (如果手动安装)
export GTEST_ROOT=/usr/local
```

### 📄 **配置文件示例**

**~/.bashrc 或 ~/.zshrc:**
```bash
# CHTL开发环境配置
export CHTL_DEV_ROOT="$HOME/workspace/CHTL"
export PATH="$CHTL_DEV_ROOT/build/src:$PATH"

# 编译器配置
export CC=clang
export CXX=clang++
export CMAKE_EXPORT_COMPILE_COMMANDS=ON

# 别名
alias chtl-build="cd $CHTL_DEV_ROOT && ./scripts/build_debug.sh"
alias chtl-test="cd $CHTL_DEV_ROOT && ./scripts/run_tests.sh"
alias chtl-clean="cd $CHTL_DEV_ROOT && ./scripts/clean_build.sh --all"
```

## 依赖验证

### ✅ **环境检查脚本**

创建 `scripts/check_environment.sh`:
```bash
#!/bin/bash

echo "CHTL Environment Checker"
echo "========================"

# 检查编译器
check_compiler() {
    echo "Checking C++ compiler..."
    
    if command -v g++ &> /dev/null; then
        echo "✓ g++ found: $(g++ --version | head -n1)"
        g++ -dumpversion | awk '{if($1>=7) print "✓ Version is sufficient"
                                  else print "✗ Version too old (need 7+)"}' 
    else
        echo "✗ g++ not found"
    fi
    
    if command -v clang++ &> /dev/null; then
        echo "✓ clang++ found: $(clang++ --version | head -n1)"
    else
        echo "⚠ clang++ not found (optional)"
    fi
}

# 检查CMake
check_cmake() {
    echo -e "\nChecking CMake..."
    
    if command -v cmake &> /dev/null; then
        echo "✓ cmake found: $(cmake --version | head -n1)"
        cmake_version=$(cmake --version | head -n1 | grep -o '[0-9]\+\.[0-9]\+')
        if [ "$(echo "$cmake_version >= 3.15" | bc -l)" -eq 1 ]; then
            echo "✓ Version is sufficient"
        else
            echo "✗ Version too old (need 3.15+)"
        fi
    else
        echo "✗ cmake not found"
    fi
}

# 检查可选依赖
check_optional() {
    echo -e "\nChecking optional dependencies..."
    
    # ANTLR4
    if pkg-config --exists antlr4-runtime; then
        echo "✓ ANTLR4 found: $(pkg-config --modversion antlr4-runtime)"
    else
        echo "⚠ ANTLR4 not found (optional)"
    fi
    
    # Google Test
    if [ -d "/usr/include/gtest" ] || [ -d "/usr/local/include/gtest" ]; then
        echo "✓ Google Test found"
    else
        echo "⚠ Google Test not found (for testing)"
    fi
    
    # Valgrind (Linux only)
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if command -v valgrind &> /dev/null; then
            echo "✓ Valgrind found: $(valgrind --version)"
        else
            echo "⚠ Valgrind not found (for memory checking)"
        fi
    fi
}

# 检查系统信息
check_system() {
    echo -e "\nSystem Information:"
    echo "OS: $(uname -s)"
    echo "Architecture: $(uname -m)"
    echo "Kernel: $(uname -r)"
    echo "CPU cores: $(nproc)"
    echo "Memory: $(free -h | awk '/^Mem:/ {print $2}')"
}

# 执行所有检查
check_compiler
check_cmake
check_optional
check_system

echo -e "\nEnvironment check complete!"
```

使用方法:
```bash
chmod +x scripts/check_environment.sh
./scripts/check_environment.sh
```

### 🔧 **依赖安装脚本**

创建 `scripts/install_dependencies.sh`:
```bash
#!/bin/bash

OS="$(uname -s)"
ARCH="$(uname -m)"

install_ubuntu_deps() {
    echo "Installing dependencies for Ubuntu/Debian..."
    
    sudo apt update
    sudo apt install -y \
        build-essential \
        cmake \
        git \
        pkg-config \
        libgtest-dev \
        libgmock-dev \
        clang \
        clang-tidy \
        clang-format \
        valgrind \
        gdb
    
    # 尝试安装ANTLR4
    if apt list --installed | grep -q antlr4; then
        sudo apt install -y libantlr4-runtime-dev antlr4
    else
        echo "ANTLR4 not available in repositories, will build from source"
        install_antlr4_from_source
    fi
}

install_centos_deps() {
    echo "Installing dependencies for CentOS/RHEL..."
    
    sudo yum groupinstall -y "Development Tools"
    sudo yum install -y cmake3 git pkgconfig gdb
    
    # 启用更新的工具集
    sudo yum install -y centos-release-scl
    sudo yum install -y devtoolset-11
}

install_macos_deps() {
    echo "Installing dependencies for macOS..."
    
    # 检查Homebrew
    if ! command -v brew &> /dev/null; then
        echo "Installing Homebrew..."
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    fi
    
    brew install cmake git googletest antlr antlr4-cpp-runtime llvm
}

install_antlr4_from_source() {
    echo "Building ANTLR4 from source..."
    
    cd /tmp
    wget https://www.antlr.org/download/antlr4-cpp-runtime-4.13.2-source.zip
    unzip antlr4-cpp-runtime-4.13.2-source.zip
    cd antlr4-cpp-runtime-4.13.2-source
    
    mkdir build && cd build
    cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=/usr/local
    make -j$(nproc)
    sudo make install
    
    cd - && rm -rf /tmp/antlr4-cpp-runtime-*
}

# 根据操作系统选择安装方法
case "$OS" in
    "Linux")
        if [ -f /etc/ubuntu-release ] || [ -f /etc/debian_version ]; then
            install_ubuntu_deps
        elif [ -f /etc/centos-release ] || [ -f /etc/redhat-release ]; then
            install_centos_deps
        else
            echo "Unsupported Linux distribution"
            exit 1
        fi
        ;;
    "Darwin")
        install_macos_deps
        ;;
    *)
        echo "Unsupported operating system: $OS"
        exit 1
        ;;
esac

echo "Dependencies installation complete!"
echo "Run './scripts/check_environment.sh' to verify installation."
```

## 故障排除

### ❌ **常见问题**

#### 1. 编译器版本过旧
```bash
# 错误信息
error: 'std::optional' is not a member of 'std'

# 解决方案
# Ubuntu: 安装更新版本的编译器
sudo apt install gcc-11 g++-11
sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 100

# CentOS: 使用软件集合
sudo yum install centos-release-scl devtoolset-11
scl enable devtoolset-11 bash
```

#### 2. CMake版本过旧
```bash
# 错误信息
CMake Error: CMake 3.15 or higher is required

# 解决方案
# 卸载旧版本
sudo apt remove cmake

# 从官方源安装
wget -O - https://apt.kitware.com/keys/kitware-archive-latest.asc | sudo apt-key add -
sudo apt-add-repository 'deb https://apt.kitware.com/ubuntu/ focal main'
sudo apt update && sudo apt install cmake
```

#### 3. ANTLR4找不到
```bash
# 错误信息
Could NOT find ANTLR4 (missing: ANTLR4_LIBRARIES ANTLR4_INCLUDE_DIRS)

# 解决方案1: 禁用ANTLR4
cmake .. -DCHTL_ENABLE_ANTLR=OFF

# 解决方案2: 手动指定路径
cmake .. -DANTLR4_ROOT=/usr/local

# 解决方案3: 设置环境变量
export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig
```

#### 4. 内存不足
```bash
# 错误信息
virtual memory exhausted: Cannot allocate memory

# 解决方案
# 减少并行编译进程数
make -j2  # 而不是 make -j$(nproc)

# 增加交换空间
sudo fallocate -l 2G /swapfile
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile
```

### 🔧 **性能调优**

#### 编译性能优化
```bash
# 使用ccache加速重复编译
sudo apt install ccache
export CC="ccache gcc"
export CXX="ccache g++"

# 使用Ninja构建器
cmake .. -G Ninja

# 启用链接时优化 (Release构建)
cmake .. -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON
```

#### 调试性能优化
```bash
# 使用gdb的并行符号加载
echo "set auto-load safe-path /" >> ~/.gdbinit

# 禁用不必要的调试信息
export CXXFLAGS="-g1"  # 最小调试信息
export CXXFLAGS="-g3"  # 完整调试信息
```

---

通过遵循本文档，您将拥有一个完整配置的CHTL开发环境。如果遇到任何问题，请参考故障排除部分或联系开发团队。