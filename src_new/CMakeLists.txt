cmake_minimum_required(VERSION 3.16)
project(CHTL_Compiler VERSION 1.0.0 LANGUAGES CXX)

# C++17æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ç¼–è¯‘å™¨ç‰¹å®šè®¾ç½®
if(MSVC)
    add_compile_options(/W4)
else()
    add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# æŸ¥æ‰¾Javaï¼ˆç”¨äºANTLR4ï¼‰
find_package(Java REQUIRED)

# è®¾ç½®ANTLR4è·¯å¾„
set(ANTLR4_JAR_PATH "${CMAKE_SOURCE_DIR}/../antlr-4.13.2-complete.jar")

# ç”ŸæˆANTLR4 CSSè§£æå™¨
set(CSS_GRAMMAR_DIR "${CMAKE_SOURCE_DIR}/../Grammars/CSS3")
set(CSS_OUTPUT_DIR "${CMAKE_BINARY_DIR}/generated/css")

add_custom_command(
    OUTPUT ${CSS_OUTPUT_DIR}/css3Lexer.cpp
           ${CSS_OUTPUT_DIR}/css3Parser.cpp
           ${CSS_OUTPUT_DIR}/css3ParserBaseListener.cpp
    COMMAND ${Java_JAVA_EXECUTABLE} -jar ${ANTLR4_JAR_PATH}
            -Dlanguage=Cpp -o ${CSS_OUTPUT_DIR}
            ${CSS_GRAMMAR_DIR}/css3Lexer.g4
            ${CSS_GRAMMAR_DIR}/css3Parser.g4
    DEPENDS ${CSS_GRAMMAR_DIR}/css3Lexer.g4
            ${CSS_GRAMMAR_DIR}/css3Parser.g4
    COMMENT "Generating CSS3 ANTLR4 files"
)

# ç”ŸæˆANTLR4 JavaScriptè§£æå™¨
set(JS_GRAMMAR_DIR "${CMAKE_SOURCE_DIR}/../Grammars/JavaScript")
set(JS_OUTPUT_DIR "${CMAKE_BINARY_DIR}/generated/js")

add_custom_command(
    OUTPUT ${JS_OUTPUT_DIR}/JavaScriptLexer.cpp
           ${JS_OUTPUT_DIR}/JavaScriptParser.cpp
           ${JS_OUTPUT_DIR}/JavaScriptParserBaseListener.cpp
    COMMAND ${Java_JAVA_EXECUTABLE} -jar ${ANTLR4_JAR_PATH}
            -Dlanguage=Cpp -o ${JS_OUTPUT_DIR}
            ${JS_GRAMMAR_DIR}/JavaScriptLexer.g4
            ${JS_GRAMMAR_DIR}/JavaScriptParser.g4
    DEPENDS ${JS_GRAMMAR_DIR}/JavaScriptLexer.g4
            ${JS_GRAMMAR_DIR}/JavaScriptParser.g4
    COMMENT "Generating JavaScript ANTLR4 files"
)

# åŒ…å«ç›®å½•
include_directories(
    ${CMAKE_SOURCE_DIR}
    ${CMAKE_BINARY_DIR}/generated
    ${CSS_OUTPUT_DIR}
    ${JS_OUTPUT_DIR}
)

# CHTLæ ¸å¿ƒæºæ–‡ä»¶
set(CHTL_SOURCES
    # CHTLè¯æ³•åˆ†æå™¨
    CHTL/CHTLLexer/CHTLLexer.h
    CHTL/CHTLLexer/GlobalMap.h
    CHTL/CHTLLexer/Token.h
    
    # CHTLèŠ‚ç‚¹
    CHTL/CHTLNode/BaseNode.h
    CHTL/CHTLNode/CommentNode.h
    CHTL/CHTLNode/TemplateNode.h
    CHTL/CHTLNode/CustomNode.h
    CHTL/CHTLNode/StyleNode.h
    CHTL/CHTLNode/ScriptNode.h
    CHTL/CHTLNode/OriginNode.h
    CHTL/CHTLNode/ImportNode.h
    CHTL/CHTLNode/ConfigNode.h
    CHTL/CHTLNode/NamespaceNode.h
    CHTL/CHTLNode/OperatorNode.h
    
    # CHTLè§£æå™¨
    CHTL/CHTLParser/CHTLParser.h
    
    # CHTLç”Ÿæˆå™¨
    CHTL/CHTLGenerator/CHTLGenerator.h
    
    # CHTLä¸Šä¸‹æ–‡
    CHTL/CHTLContext/CHTLContext.h
    
    # CHTLåŠ è½½å™¨
    CHTL/CHTLLoader/CHTLLoader.h
    
    # CHTLçŠ¶æ€æœº
    CHTL/CHTLState/CHTLState.h
    
    # CHTLç®¡ç†å™¨
    CHTL/CHTLManage/CHTLManage.h
    
    # CMODç³»ç»Ÿ
    CHTL/CMODSystem/CMODSystem.h
)

# CHTL JSæºæ–‡ä»¶
set(CHTLJS_SOURCES
    # CHTL JSè¯æ³•åˆ†æå™¨
    CHTLJS/CHTLJSLexer/CHTLJSLexer.h
    CHTLJS/CHTLJSLexer/CHTLJSGlobalMap.h
    CHTLJS/CHTLJSLexer/CHTLJSToken.h
    
    # CHTL JSèŠ‚ç‚¹
    CHTLJS/CHTLJSNode/CHTLJSNodes.h
    
    # CHTL JSè§£æå™¨
    CHTLJS/CHTLJSParser/CHTLJSParser.h
    
    # CHTL JSç”Ÿæˆå™¨
    CHTLJS/CHTLJSGenerator/CHTLJSGenerator.h
    
    # CHTL JSä¸Šä¸‹æ–‡
    CHTLJS/CHTLJSContext/CHTLJSContext.h
    
    # CHTL JSåŠ è½½å™¨
    CHTLJS/CHTLJSLoader/CHTLJSLoader.h
    
    # CHTL JSçŠ¶æ€æœº
    CHTLJS/CHTLJSState/CHTLJSState.h
    
    # CHTL JSç®¡ç†å™¨
    CHTLJS/CHTLJSManage/CHTLJSManage.h
    
    # CJMODç³»ç»Ÿ
    CHTLJS/CJMODSystem/CJMODSystem.h
)

# CSSå’ŒJSç¼–è¯‘å™¨æºæ–‡ä»¶
set(CSS_JS_SOURCES
    CSS/CSSCompiler.h
    JS/JavaScriptCompiler.h
)

# æ‰«æå™¨æºæ–‡ä»¶
set(SCANNER_SOURCES
    Scanner/CHTLUnifiedScanner.h
    Scanner/CJMODScanner.h
)

# ç¼–è¯‘å™¨è°ƒåº¦å™¨æºæ–‡ä»¶
set(DISPATCHER_SOURCES
    CompilerDispatcher/CompilerDispatcher.h
)

# å·¥å…·ç±»æºæ–‡ä»¶
set(UTIL_SOURCES
    Util/FileSystem/FileSystem.h
    Util/FileSystem/ZipLibrary.h
)

# ANTLRç”Ÿæˆçš„æºæ–‡ä»¶
set(ANTLR_SOURCES
    ${CSS_OUTPUT_DIR}/css3Lexer.cpp
    ${CSS_OUTPUT_DIR}/css3Parser.cpp
    ${CSS_OUTPUT_DIR}/css3ParserBaseListener.cpp
    ${JS_OUTPUT_DIR}/JavaScriptLexer.cpp
    ${JS_OUTPUT_DIR}/JavaScriptParser.cpp
    ${JS_OUTPUT_DIR}/JavaScriptParserBaseListener.cpp
)

# åˆå¹¶æ‰€æœ‰æºæ–‡ä»¶
set(ALL_SOURCES
    ${CHTL_SOURCES}
    ${CHTLJS_SOURCES}
    ${CSS_JS_SOURCES}
    ${SCANNER_SOURCES}
    ${DISPATCHER_SOURCES}
    ${UTIL_SOURCES}
    ${ANTLR_SOURCES}
)

# åˆ›å»ºCHTLç¼–è¯‘å™¨åº“ï¼ˆä»…å¤´æ–‡ä»¶æ¥å£åº“ï¼‰
add_library(chtl_compiler_lib INTERFACE)

# è®¾ç½®INTERFACEåº“çš„åŒ…å«ç›®å½•
target_include_directories(chtl_compiler_lib INTERFACE
    ${CMAKE_SOURCE_DIR}
    ${CMAKE_BINARY_DIR}/generated
    ${CSS_OUTPUT_DIR}
    ${JS_OUTPUT_DIR}
)

# åˆ›å»ºå¯æ‰§è¡Œæ–‡ä»¶
add_executable(chtl_compiler Test/main.cpp)

# åˆ›å»ºCJMODæµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
add_executable(test_cjmod Test/test_cjmod.cpp)

# é“¾æ¥åº“
target_link_libraries(chtl_compiler chtl_compiler_lib)
target_link_libraries(test_cjmod chtl_compiler_lib)

# è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶å±æ€§
set_target_properties(chtl_compiler PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

set_target_properties(test_cjmod PROPERTIES
    CXX_STANDARD 17
    CXX_STANDARD_REQUIRED ON
)

# ä¸ºå¯æ‰§è¡Œæ–‡ä»¶å•ç‹¬è®¾ç½®C++æ ‡å‡†
target_compile_features(chtl_compiler PRIVATE cxx_std_17)
target_compile_features(test_cjmod PRIVATE cxx_std_17)

# å®‰è£…ç›®æ ‡
install(TARGETS chtl_compiler test_cjmod
        RUNTIME DESTINATION bin)

install(TARGETS chtl_compiler_lib
        LIBRARY DESTINATION lib
        ARCHIVE DESTINATION lib)

# å®‰è£…å¤´æ–‡ä»¶
install(DIRECTORY CHTL/ DESTINATION include/CHTL
        FILES_MATCHING PATTERN "*.h")

install(DIRECTORY CHTLJS/ DESTINATION include/CHTLJS
        FILES_MATCHING PATTERN "*.h")

install(DIRECTORY CSS/ DESTINATION include/CSS
        FILES_MATCHING PATTERN "*.h")

install(DIRECTORY JS/ DESTINATION include/JS
        FILES_MATCHING PATTERN "*.h")

install(DIRECTORY Scanner/ DESTINATION include/Scanner
        FILES_MATCHING PATTERN "*.h")

install(DIRECTORY CompilerDispatcher/ DESTINATION include/CompilerDispatcher
        FILES_MATCHING PATTERN "*.h")

install(DIRECTORY Util/ DESTINATION include/Util
        FILES_MATCHING PATTERN "*.h")

# æ¨¡å—å®‰è£…
install(DIRECTORY Module/ DESTINATION share/chtl/modules
        PATTERN "*.chtl" PATTERN "*.h" PATTERN "*.cpp")

# è®¾ç½®æ„å»ºä¿¡æ¯
configure_file(
    "${CMAKE_SOURCE_DIR}/../version.h.in"
    "${CMAKE_BINARY_DIR}/version.h"
    @ONLY
)

# æ·»åŠ è‡ªå®šä¹‰ç›®æ ‡ç”¨äºæ¸…ç†ANTLRç”Ÿæˆçš„æ–‡ä»¶
add_custom_target(clean-antlr
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${CSS_OUTPUT_DIR}
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${JS_OUTPUT_DIR}
    COMMENT "Cleaning ANTLR generated files"
)

# æ‰“å°é…ç½®ä¿¡æ¯
message(STATUS "CHTL Compiler Configuration:")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "  Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "  Source Directory: ${CMAKE_SOURCE_DIR}")
message(STATUS "  Binary Directory: ${CMAKE_BINARY_DIR}")
message(STATUS "  ANTLR4 JAR: ${ANTLR4_JAR_PATH}")
message(STATUS "  CSS Grammar: ${CSS_GRAMMAR_DIR}")
message(STATUS "  JS Grammar: ${JS_GRAMMAR_DIR}")

# ç¼–è¯‘ä¿¡æ¯
message(STATUS "Components to build:")
message(STATUS "  - CHTL Core Compiler")
message(STATUS "  - CHTL JS Compiler") 
message(STATUS "  - CSS Compiler (ANTLR4)")
message(STATUS "  - JavaScript Compiler (ANTLR4)")
message(STATUS "  - Unified Scanner")
message(STATUS "  - Compiler Dispatcher")
message(STATUS "  - Module System")
message(STATUS "  - Test Executable")

# Debugä¿¡æ¯
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    message(STATUS "Debug build enabled")
    add_compile_definitions(CHTL_DEBUG=1)
else()
    message(STATUS "Release build enabled")
    add_compile_definitions(CHTL_RELEASE=1)
endif()

message(STATUS "ğŸ‰ CHTLç¼–è¯‘å™¨é¡¹ç›®é…ç½®å®Œæˆï¼")
message(STATUS "ğŸ’¾ ä½¿ç”¨ 'make' æˆ– 'cmake --build .' æ¥æ„å»ºé¡¹ç›®")
message(STATUS "ğŸš€ è¿è¡Œ './chtl_compiler' æ¥å¯åŠ¨CHTLç¼–è¯‘å™¨æµ‹è¯•")